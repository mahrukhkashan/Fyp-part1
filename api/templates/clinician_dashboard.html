<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinician Dashboard - Sepsis Prediction System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-heartbeat me-2"></i>Sepsis AI Assistant
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="patientSearchBtn">
                            <i class="fas fa-search me-1"></i>Search Patient
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#predictionModal">
                            <i class="fas fa-stethoscope me-1"></i>New Prediction
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="chatbotBtn">
                            <i class="fas fa-robot me-1"></i>AI Assistant
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-md me-1"></i>Dr. {{ session.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-chart-line me-2"></i>Quick Stats
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Total Predictions</span>
                            <span class="badge bg-primary" id="totalPredictions">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>High Risk Cases</span>
                            <span class="badge bg-danger" id="highRiskCases">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Model Accuracy</span>
                            <span class="badge bg-success" id="modelAccuracy">0%</span>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alerts
                    </div>
                    <div class="card-body">
                        <div id="alertsList">
                            <div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                                <small><i class="fas fa-clock me-1"></i> 2 hours ago</small>
                                <p class="mb-0">Patient #4521 shows deteriorating vitals</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard -->
            <div class="col-lg-9">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-users me-2"></i>Recent Patients</span>
                                <button class="btn btn-sm btn-light" onclick="loadRecentPatients()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="patientsTable">
                                        <thead>
                                            <tr>
                                                <th>Patient ID</th>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Risk Level</th>
                                                <th>Last Prediction</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Patient rows will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-chart-pie me-2"></i>Risk Distribution
                            </div>
                            <div class="card-body">
                                <canvas id="riskChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <i class="fas fa-chart-bar me-2"></i>Model Performance
                            </div>
                            <div class="card-body">
                                <canvas id="performanceChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results Section -->
                <div class="row d-none" id="predictionResults">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-clipboard-check me-2"></i>Prediction Results
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">Sepsis Risk</h5>
                                                <div class="display-4 fw-bold" id="riskPercentage">0%</div>
                                                <span class="badge" id="riskBadge">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">Key Factors</h5>
                                                <ul class="list-group list-group-flush" id="keyFactors">
                                                    <!-- Factors will be loaded here -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Detailed Explanation</h5>
                                                <div id="detailedExplanation">
                                                    <p>Explanation will appear here...</p>
                                                </div>
                                                <button class="btn btn-primary mt-3" onclick="showFullExplanation()">
                                                    <i class="fas fa-chart-line me-2"></i>View Full Analysis
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Prediction Modal -->
    <div class="modal fade" id="predictionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-stethoscope me-2"></i>New Sepsis Prediction</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="predictionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Patient ID</label>
                                    <input type="number" class="form-control" id="patientId" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Age</label>
                                    <input type="number" class="form-control" id="patientAge" required>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4 mb-3"><i class="fas fa-heartbeat me-2"></i>Vital Signs</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Heart Rate (bpm)</label>
                                    <input type="number" class="form-control" id="heartRate" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Temperature (°C)</label>
                                    <input type="number" class="form-control" id="temperature" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Respiratory Rate</label>
                                    <input type="number" class="form-control" id="respiratoryRate" required>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4 mb-3"><i class="fas fa-flask me-2"></i>Lab Results</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">White Blood Cells (×10⁹/L)</label>
                                    <input type="number" class="form-control" id="wbc" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lactate (mmol/L)</label>
                                    <input type="number" class="form-control" id="lactate" step="0.1" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Blood Pressure (Systolic)</label>
                                    <input type="number" class="form-control" id="systolicBP" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Blood Pressure (Diastolic)</label>
                                    <input type="number" class="form-control" id="diastolicBP" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="makePrediction()">
                        <i class="fas fa-calculator me-2"></i>Calculate Risk
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Modal -->
    <div class="modal fade" id="chatbotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-robot me-2"></i>AI Assistant</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="height: 400px; overflow-y: auto;">
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message bot-message mb-3">
                            <div class="message-bubble">
                                <strong>Sepsis Assistant:</strong> Hello! I'm your sepsis prediction assistant. How can I help you today?
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="Type your question...">
                        <button class="btn btn-success" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadRecentPatients();
            initializeCharts();
            
            // Chatbot button
            document.getElementById('chatbotBtn').addEventListener('click', function() {
                new bootstrap.Modal(document.getElementById('chatbotModal')).show();
            });
            
            // Patient search
            document.getElementById('patientSearchBtn').addEventListener('click', function() {
                const patientId = prompt('Enter Patient ID:');
                if (patientId) {
                    loadPatient(patientId);
                }
            });
        });

        function loadDashboardData() {
            fetch('/api/dashboard_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalPredictions').textContent = data.total_predictions;
                        document.getElementById('highRiskCases').textContent = data.high_risk_cases;
                        document.getElementById('modelAccuracy').textContent = data.model_accuracy + '%';
                    }
                });
        }

        function loadRecentPatients() {
            fetch('/api/recent_patients')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#patientsTable tbody');
                    tbody.innerHTML = '';
                    
                    data.patients.forEach(patient => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${patient.id}</td>
                            <td>${patient.name}</td>
                            <td>${patient.age}</td>
                            <td><span class="badge ${getRiskBadgeClass(patient.risk_level)}">${patient.risk_level}</span></td>
                            <td>${patient.last_prediction}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewPatient(${patient.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="predictForPatient(${patient.id})">
                                    <i class="fas fa-calculator"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }

        function makePrediction() {
            const formData = {
                patient_id: document.getElementById('patientId').value,
                age: document.getElementById('patientAge').value,
                heart_rate: document.getElementById('heartRate').value,
                temperature: document.getElementById('temperature').value,
                respiratory_rate: document.getElementById('respiratoryRate').value,
                wbc: document.getElementById('wbc').value,
                lactate: document.getElementById('lactate').value,
                systolic_bp: document.getElementById('systolicBP').value,
                diastolic_bp: document.getElementById('diastolicBP').value
            };

            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('predictionModal')).hide();
                    
                    // Show results
                    displayPredictionResults(data);
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }

        function displayPredictionResults(data) {
            document.getElementById('predictionResults').classList.remove('d-none');
            document.getElementById('riskPercentage').textContent = (data.probability * 100).toFixed(1) + '%';
            document.getElementById('riskBadge').textContent = data.risk_level;
            document.getElementById('riskBadge').className = 'badge ' + getRiskBadgeClass(data.risk_level);
            
            // Scroll to results
            document.getElementById('predictionResults').scrollIntoView({ behavior: 'smooth' });
        }

        function getRiskBadgeClass(riskLevel) {
            switch(riskLevel.toLowerCase()) {
                case 'high risk': return 'bg-danger';
                case 'medium risk': return 'bg-warning';
                case 'low risk': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        function initializeCharts() {
            // Risk distribution chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            new Chart(riskCtx, {
                type: 'pie',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: [60, 25, 15],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                }
            });

            // Performance chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score'],
                    datasets: [{
                        label: 'Model Performance',
                        data: [85, 82, 88, 85],
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Send to server
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                addChatMessage(data.response, 'bot');
            });
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message mb-3`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = `<strong>${sender === 'bot' ? 'Sepsis Assistant' : 'You'}:</strong> ${message}`;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>